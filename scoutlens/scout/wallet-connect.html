<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout - Connect Wallet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .wallet-connect-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .scout-logo {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .subtitle {
            opacity: 0.8;
            margin-bottom: 32px;
            font-size: 14px;
        }
        
        .wallet-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        
        .status-text {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .status-detail {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .connect-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .connect-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fecaca;
        }
        
        .success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #a7f3d0;
        }
    </style>
</head>
<body>
    <div class="wallet-connect-container">
        <div class="scout-logo">üîç</div>
        <h1>Scout Wallet Connection</h1>
        <p class="subtitle">Connect your MetaMask wallet to start using Scout</p>
        
        <div class="wallet-status" id="walletStatus">
            <div class="status-icon" id="statusIcon">ü¶ä</div>
            <div class="status-text" id="statusText">Checking MetaMask...</div>
            <div class="status-detail" id="statusDetail">Please wait while we detect your wallet</div>
        </div>
        
        <button class="connect-btn" id="connectBtn" disabled>
            <span class="loading" id="loadingSpinner"></span>
            <span>Connecting...</span>
        </button>
        
        <button class="close-btn" id="closeBtn">Close</button>
    </div>

    <script>
        console.log('Scout wallet connection popup loaded');
        
        let walletState = {
            hasMetaMask: false,
            connected: false,
            account: null,
            chainId: null
        };

        // Initialize wallet connection popup
        async function initWalletPopup() {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');
            const walletStatus = document.getElementById('walletStatus');
            const connectBtn = document.getElementById('connectBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            try {
                // Check if MetaMask is available
                if (typeof window.ethereum !== 'undefined') {
                    walletState.hasMetaMask = true;
                    
                    statusIcon.textContent = 'ü¶ä';
                    statusText.textContent = 'MetaMask Detected';
                    statusDetail.textContent = 'Ready to connect to your wallet';
                    
                    // Check if already connected
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        walletState.connected = true;
                        walletState.account = accounts[0];
                        walletState.chainId = await window.ethereum.request({ method: 'eth_chainId' });
                        
                        showConnectedState();
                    } else {
                        showReadyToConnect();
                    }
                } else {
                    // MetaMask not found
                    statusIcon.textContent = '‚ùå';
                    statusText.textContent = 'MetaMask Not Found';
                    statusDetail.textContent = 'Please install MetaMask extension to continue';
                    walletStatus.classList.add('error');
                    
                    connectBtn.innerHTML = 'üì• Install MetaMask';
                    connectBtn.disabled = false;
                    loadingSpinner.style.display = 'none';
                    
                    connectBtn.onclick = () => {
                        window.open('https://metamask.io/download/', '_blank');
                    };
                }
            } catch (error) {
                console.error('Error initializing wallet popup:', error);
                showError('Failed to initialize wallet connection');
            }
        }
        
        function showReadyToConnect() {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');
            const connectBtn = document.getElementById('connectBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            statusIcon.textContent = 'üîó';
            statusText.textContent = 'Ready to Connect';
            statusDetail.textContent = 'Click the button below to connect your wallet';
            
            connectBtn.innerHTML = 'ü¶ä Connect MetaMask';
            connectBtn.disabled = false;
            loadingSpinner.style.display = 'none';
            
            connectBtn.onclick = connectWallet;
        }
        
        function showConnectedState() {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');
            const walletStatus = document.getElementById('walletStatus');
            const connectBtn = document.getElementById('connectBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            statusIcon.textContent = '‚úÖ';
            statusText.textContent = 'Wallet Connected';
            statusDetail.textContent = `${walletState.account.substring(0, 6)}...${walletState.account.substring(38)}`;
            walletStatus.classList.add('success');
            
            connectBtn.innerHTML = '‚úÖ Connected - You can close this window';
            connectBtn.disabled = true;
            loadingSpinner.style.display = 'none';
            
            // Send success message to extension
            sendMessageToExtension('WALLET_CONNECTED', {
                account: walletState.account,
                chainId: walletState.chainId,
                connected: true
            });
            
            // Auto-close after 3 seconds
            setTimeout(() => {
                window.close();
            }, 3000);
        }
        
        function showError(message) {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');
            const walletStatus = document.getElementById('walletStatus');
            const connectBtn = document.getElementById('connectBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            statusIcon.textContent = '‚ùå';
            statusText.textContent = 'Connection Failed';
            statusDetail.textContent = message;
            walletStatus.classList.add('error');
            
            connectBtn.innerHTML = 'üîÑ Try Again';
            connectBtn.disabled = false;
            loadingSpinner.style.display = 'none';
            
            connectBtn.onclick = connectWallet;
        }
        
        async function connectWallet() {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusDetail = document.getElementById('statusDetail');
            const connectBtn = document.getElementById('connectBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            try {
                statusIcon.textContent = 'üîÑ';
                statusText.textContent = 'Connecting...';
                statusDetail.textContent = 'Please approve the connection in MetaMask';
                
                connectBtn.innerHTML = '<span class="loading"></span> Connecting...';
                connectBtn.disabled = true;
                
                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length > 0) {
                    walletState.connected = true;
                    walletState.account = accounts[0];
                    walletState.chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    
                    showConnectedState();
                } else {
                    throw new Error('No accounts returned from MetaMask');
                }
                
            } catch (error) {
                console.error('Wallet connection error:', error);
                
                let errorMessage = 'Unknown error occurred';
                if (error.code === 4001) {
                    errorMessage = 'Connection rejected by user';
                } else if (error.code === -32002) {
                    errorMessage = 'Connection request already pending';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
                
                // Send error message to extension
                sendMessageToExtension('WALLET_ERROR', {
                    error: errorMessage,
                    code: error.code
                });
            }
        }
        
        function sendMessageToExtension(type, data) {
            // Try to communicate with the extension
            try {
                // Use postMessage to communicate with opener window
                if (window.opener) {
                    window.opener.postMessage({
                        source: 'scout-wallet-popup',
                        type: type,
                        data: data
                    }, '*');
                }
                
                // Also try to send to extension directly
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    chrome.runtime.sendMessage({
                        type: type,
                        data: data,
                        source: 'wallet-popup'
                    });
                }
            } catch (error) {
                console.error('Error sending message to extension:', error);
            }
        }
        
        // Close button handler
        document.getElementById('closeBtn').onclick = () => {
            sendMessageToExtension('WALLET_POPUP_CLOSED', {});
            window.close();
        };
        
        // Handle wallet events
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    showReadyToConnect();
                } else {
                    walletState.account = accounts[0];
                    sendMessageToExtension('WALLET_ACCOUNT_CHANGED', {
                        account: accounts[0]
                    });
                }
            });
            
            window.ethereum.on('chainChanged', (chainId) => {
                walletState.chainId = chainId;
                sendMessageToExtension('WALLET_CHAIN_CHANGED', {
                    chainId: chainId
                });
            });
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWalletPopup);
        } else {
            initWalletPopup();
        }
    </script>
</body>
</html>
